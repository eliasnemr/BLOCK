<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
  <title>BLOCK</title>

  <!-- CSS  -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
  <link href="css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="css/custom.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <script src="js/jquery-3.5.1.min.js"></script>
</head>

<body>
<script type="text/javascript">

    $(document).ready(function(){

      Minima.init(function(msg){});

      var txpow_ = Minima.form.getParams("txpow");

      Minima.sql("SELECT * FROM txpowlist WHERE HASH = '"+txpow_+"'", function(txpow){
        console.log(txpow);
        if(txpow.response.status && txpow.response.rows.length > 0) {
          //setDetails(txpow);
          loadDetails(txpow);
        } else {
          // alert div 
          var markup = '<div id="notfound" class="row center">'+
                        '<div class="col s12">'+
                          '<p>Something went wrong, details for block not found!<p>'+
                        '</div>'+
                       '</div>'+
                       '<br>'+
                       '<div id="notfound" class="row center">'+
                        '<div class="col s12">'+
                          '<a class="backBtn btn-small btn-flat">Back To Explorer<p>'+
                        '</div>'+
                       '</div>';
          
          $('#nav-wrapper').after(markup);

          $('#nav-wrapper').addClass('hide');

          $('#content').addClass('hide');

          setTimeout(function() {
            window.history.back(); 
          }, 3000);

        }

      });
      
      // dark mode
      Minima.file.load("userPreference.txt", function(res){
        if(res.success){
          var preference = JSON.parse(res.data);
    
          if(preference.mode == "dark"){
            $('body').addClass("dark");
            $('.body-icon').attr("src", "assets/blocklogowhitetext.svg");
          } else if(preference.mode == "light"){
            $('body').removeClass("dark");  
            $('.body-icon').attr("src", "assets/blocklogo.svg");
          }
        }
    
      });

      // tool info display
      $('.tooltipped').tooltip();

      // elias github
      $("#elias").on("click", function(){
        window.open('https://github.com/eliasnemr', '_blank'); 
      });

      $(document).on("click", ".pulse", function(){
        $('.tip').toggle("slide");
        $('.tip2').toggle("slide");
      });   
      
      $(document).on("click", ".details-btn", function() {
        // console.log('details-btn pressed');
        $('.details').toggle("slide");

        if ($('.details-btn').find('i').text() == 'add'){
          $(this).find('i').text('close');
        } else {
          $(this).find('i').text('add');
        }

      });
});
function parentClicked() {
  var parent = document.getElementById("parent").textContent;
  var blk = $('#height').text();

  window.location.search = location.search.replace(/txpow=[^&$]*/i, 'txpow='+parent);
  return false;

}
function txnClicked(hash) {
  window.location.search = location.search.replace(/txpow=[^&$]*/i, 'txpow='+hash);
  return false;
}

function loadDetails(data) {

    // if valid parse txpow
    if (data) {
      new Promise((resolve, reject) => {

        data = JSON.parse(data.response.rows[0].TXPOW);
        // txpow json data object
        let txpow = {
          id: data.txpowid, // TXPOW ID
          blocknumber: data.header.block, // BLOCK NUMBER
          isblock: data.isblock,
          nonce: data.header.nonce,
          superblock: data.superblock,
          time: moment(data.header.timesecs*1000).format("DD MMMM YYYY HH:MM a"),
          out_amount: data.body.txn.outputs.length,
          inp_amount: data.body.txn.inputs.length,
          txn_amount: data.body.txnlist.length,
          size: data.size,
          parent: data.header.superparents[0].parent,
          type: (data.body.txn.inputs.length > 0 ? "Value Transfer" : "Pulse"),
          isTokenCreator: (data.body.txn.tokengen ? "Yes" : "No"),
          message: (data.body.txn.state.length>0 && data.body.txn.state[0].data == '01000100' ? data.body.txn.state[1].data : false) 
        }
        resolve(txpow);
      }).then(txpow => {
        console.log(txpow);


        let markup = '<div id="blockDetails" class="row">'+
                        '<div class="col offset-s1 s9">'+
                          '<ul class="collection with-header">'+
                            '<li class="collection-header"><h4>Block '+txpow.blocknumber+'</h4></li>'+
                            '<li class="collection-item row"><div class="col m3 s12">TxPoW ID</div><a class="secondary-content col m9 s12">'+txpow.id+'</a></li>'+
                            '<li class="collection-item row"><div class="col m3 s12">Timestamp</div><a class="secondary-content col m9 s12">'+txpow.time+'</a></li>'+
                            '<li class="collection-item row"><div class="col m3 s12">Size</div><a class="secondary-content col m9 s12">'+txpow.size+'</a></li>'+
                            '<li class="collection-item row"><div class="col m3 s12">Number of transactions</div><a class="secondary-content col m9 s12">'+txpow.txn_amount+'</a></li>'+
                            '<li class="collection-item row"><div class="col m3 s12">Is a block?</div><a class="secondary-content col m9 s12">'+txpow.isblock+'</a></li>'+
                            '<li class="collection-item row"><div class="col m3 s12">Nonce</div><a class="secondary-content col m9 s12">'+txpow.nonce+'</a></li>'+
                            '<li class="collection-item row"><div class="col m3 s12">Superblock level</div><a class="secondary-content col m9 s12">'+txpow.superblock+'</a></li>'+
                            '<li class="collection-item row"><div class="col m3 s12">Parent</div><a class="secondary-content col m9 s12">'+txpow.parent+'</a></li>'+
                          '</ul>'+
                        '</div>'+
                      '</div>';
        $('#nav-wrapper').after(markup);


      });
      
      //$('#nav-blocks').html("Block "+txpow.blocknumber);

    }





}

function setDetails(txpow) {
  
  txpow = JSON.parse(txpow.response.rows[0].TXPOW);

  $("#hash").html(txpow.txpowid);
  $("#nav-blocks").html("Block "+txpow.header.block);
  $("#height").html(txpow.header.block);

  if(txpow.isblock == true){

      $("#isblock").html("Yes");

  } else {

      $("#isblock").html("No");

  }

  $("#nonce").html(txpow.header.nonce);
  $("#superparents-amnt").html(txpow.superblock);
  var time = moment(txpow.header.timesecs*1000).format("DD MMMM YYYY HH:MM a");
  $("#timestamp").html(time);
  $("#header").html("Block "+ txpow.header.block);
  $("#outputs").html(txpow.body.txn.outputs.length);
  $("#inputs").html(txpow.body.txn.inputs.length);
  $("#txns").html(txpow.body.txnlist.length);
  $("#size").html(txpow.size);
  $("#parent").html(txpow.header.superparents[0].parent);
  if(txpow.body.txn.inputs.length > 0) {
    $("#_type").css("display", "block");
    $("#type").html("Value transfer");
  }
  if(txpow.body.txn.tokengen) {
    $("#token").html(txpow.body.txn.tokengen.token);
    $("#_token").css("display", "block");
    $("#type").html("Token creation");
  } 
  var state = txpow.body.txn.state;
  if(state.length > 0 && state[0].data == '01000100') {
    $('#msg').css("display", "block");
    $('#message').html(state[1].data);
  }
  if(txpow.body.txn.inputs.length > 0){

    var tmpl = $.templates('#txn-template');

    var inputs = []; var outputs = []; var input_index; var output_index; var txn_index;
    var scripts = [];
    // get TXN input scripts
    $.each(txpow.body.witness.scripts, function(i, el){
      scripts.push({script_index: i, script: el.script, data: el.proof.data, hashbits: el.proof.hashbits, proofchain: el.proof.proofchain, chainsha: el.proof.chainsha, finalhash: el.proof.finalhash });
    });
    // get TXN inputs
    $.each(txpow.body.txn.inputs, function(i, el){
      inputs.push({input_index: i, inAddress: el.address, inAmount: el.amount, inTokenID: el.tokenid, inFloating: el.floating, inRemainder: el.remainder, scripts: scripts});
    });
    // get TXN outputs
    $.each(txpow.body.txn.outputs, function(i, el){
      outputs.push({output_index: i, outAddress: el.address, outAmount: el.amount, outTokenID: el.tokenid, outFloating: el.floating, outRemainder: el.remainder});
    });

    
    // create txn
    var txn = { txn_index: 0, inputs: inputs, outputs: outputs };

    // render
    var html = tmpl.render(txn);

    $('.collection').after(html);

  } else if(txpow.body.txn.inputs.length > 0 && txpow.body.txnlist.length > 0){

    var tmpl = $.templates('#txn-template');
    var tmpl_txnlist = $.templates('#txnlist-template');

    var inputs = []; var outputs = [];var txnlist = []; var input_index; var output_index; var txn_index;
    var scripts = [];
    // get TXN input scripts
    $.each(txpow.body.witness.scripts, function(i, el){
      scripts.push({script_index: i, script: el.script, data: el.proof.data, hashbits: el.proof.hashbits, proofchain: el.proof.proofchain, chainsha: el.proof.chainsha, finalhash: el.proof.finalhash });
    });
    // get TXN inputs
    $.each(txpow.body.txn.inputs, function(i, el){
      inputs.push({input_index: i, inAddress: el.address, inAmount: el.amount, inTokenID: el.tokenid, inFloating: el.floating, inRemainder: el.remainder, scripts: scripts});
    });
    // get TXN outputs
    $.each(txpow.body.txn.outputs, function(i, el){
      outputs.push({output_index: i, outAddress: el.address, outAmount: el.amount, outTokenID: el.tokenid, outFloating: el.floating, outRemainder: el.remainder});
    });
    $.each(txpow.body.txnlist, function(i, el){
      txnlist.push({index:i, hash: el});
    });

    // create txn
    var txn = { txn_index: 0, inputs: inputs, outputs: outputs };
    // render
    var html = tmpl.render(txn);

    // create txnlist 
    var txnlist = { txnlist: txnlist};

    var html_txnlist = tmpl_txnlist.render(txnlist);

    $('.collection').after(html);
    $('.collection').after(html_txnlist);

    
  } else if(!txpow.body.txn.inputs.length > 0 && txpow.body.txnlist.length > 0){
    var txnlist = [];
    var tmpl_txnlist = $.templates('#txnlist-template');

    $.each(txpow.body.txnlist, function(i, el){
      txnlist.push({index:i, hash: el});
    });

    localStorage.setItem("txnlist", JSON.stringify(txnlist));

    // create txnlist 
    var txnlist = { txnlist: txnlist };
    // render inside the template
    var html_txnlist = tmpl_txnlist.render(txnlist);
    // add it to html
    $('.collection').after(html_txnlist);
  
  } else {

    $('.collection').after("<div class='row center'><a class='btn-small pulse tooltipped' data-html='true' data-position='right' data-tooltip='TEST'>Pulse TXN<i class='material-icons tip'>show_chart</i><i class='material-icons tip2' style='display:none;'>multiline_chart</i></a><p class='tip' style='display:none;'>This transaction is a Pulse, so it has no inputs and outputs.</p></div>");
  
    }
}
</script>
<script id="txn-template" type="text/x-jsrender">
  <!-- TRANSACTIONS -->
  <div class="row txn" id="txn-template">

    <div class="col s8">
      <p>TXN #{{:txn_index}}</p>
    </div>

    <div class="col s3" >
      <p>
        <a class="waves-effect waves-light btn-flat details-btn">Details <i class=" material-icons right details-icon " style="font-size: 15px;">add</i></a>
      </p>
    </div>


    <div class="container txn-container">
      <div class="row">

      {{for inputs}}
        <div class="col s5 input">
          <div class="row">
            <div class="col s1">
              <p id="index">#{{:input_index}}</p>
            </div>
            <div class="col s9">
              <p class="address">{{:inAddress}}</p>
            </div>
            <div class="col s2 amnt">
              <p>{{:inAmount}}</p>
            </div>
          </div>
          <div class="row details">
            <ul class="collection" style="line-style: none;">
              <li class="collection-item">
              <div>Token ID
                <a href="#!" class="secondary-content">{{:inTokenID}}</a>
              </div>
              </li>
              <li class="collection-item">
                <div>Floating
                  <a href="#!" class="secondary-content">{{:inFloating}}</a>
                </div>
                </li>
              <li class="collection-item">
                <div>Remainder
                  <a href="#!" class="secondary-content">{{:inRemainder}}</a>
                </div>
              </li>
              
            {{if scripts}}
              {{for scripts}}
              <li class="collection-item script">
                <div>Script #{{:script_index}}
                  <a href="#!" class="secondary-content script">{{:script}}</a>
                </div>
              </li>
              {{/for}}
            {{/if}}
            </ul>
          </div> 
        </div>
      {{/for}}

      <div class="col s2 chevron">
        <p class="center"> <i class="material-icons ">chevron_right</i> </p>
      </div>

      
      <div class="col s5 output">
        {{for outputs}}
        <div class="row">
          <div class="col s1">
            <p id="index">#{{:output_index}}</p> 
          </div>
          <div class="col s9">
            <p class="address"> {{:outAddress}} </p>
          </div>
          <div class="col s2 amnt">
            <p>{{:outAmount}}</p>
          </div>
        </div>

        <div class="row details">
          <ul class="collection" style="line-style: none;">
            <li class="collection-item">
            <div>Token ID
              <a href="#!" class="secondary-content">{{:outTokenID}}</a>
            </div>
            </li>
            <li class="collection-item">
              <div>Floating
                <a href="#!" class="secondary-content">{{:outFloating}}</a>
              </div>
              </li>
              <li class="collection-item">
                <div>Remainder
                  <a href="#!" class="secondary-content">{{:outRemainder}}</a>
                </div>
                </li>
          </ul>
        </div> 

        <div class="divider"></div>
      {{/for}}
      </div>

      </div>
    </div>

</div>

</script>

<script id="txnlist-template" type="text/x-jsrender">
  <div class="row">
    <ul class="collection with-header">
      <li class="collection-header"><h4>Transaction List</h4></li>
      
      {{for txnlist}}
       <li onclick='txnClicked( "{{:hash}}" )' class="collection-item hash-wrapper"><div>
          <div class="of-text">TXN #{{:index}}</div>
          <a href="#" id="txn-hash" class="secondary-content">{{:hash}}</a>
         </div>
      </li>

      {{/for}}

    </ul>
  </div>
  
</script>
<script id="scriptTemplate" type="text/x-jsrender">
  {{for scripts}}
  <li class="secondary-content">
    {{:script}}
  </li>
  {{/for}}
</script>

<div id="wrapper">
  <header>
    <nav class="menu navbar-fixed" role="navigation">
      <div id="header" class="row">
        <div style="padding-left:2.1%;padding-top:2.5%;padding-bottom:2%" class="col push-s1 s4">
          <img style="width:200px;" src="assets/block2.svg" alt="logo">
        </div>
      </div>
    </nav>

    <div style="flex-direction: row!important; padding-left: 10%;" id="nav-wrapper" class="row">
      <div class="col">
        <div class="nav-wrapper">
          <a href="index.html" class="breadcrumb explorer">Explorer</a>
          <a href="#!" class="breadcrumb explorer" id="nav-blocks"></a>
        </div>
      </div>
    </div>
  </header>
  
  <!-- Details BODY INFO -->
  <div id="content">







        <!-- <div class="row">
          <div class="col s12">
            <i class='material-icons left info tooltipped' data-html='true' data-position='top' data-tooltip='Block number referencing at which height this block is currently in the Minima blockchain'>info</i>
            <div id="header"></div>
          </div>    
        </div>
         
        <ul class="collection">
          <li class="collection-item tooltipped" data-html="true" data-position="top" data-tooltip="Height number of current block in the chain"><div>Height
              <a href="#!" id="height" class="secondary-content"></a>
            </div>
          </li>
          <li class="collection-item tooltipped hash-wrapper" data-html="true" data-position="top" data-tooltip="Unique identifier of block"><div class="of-text">TxPoW ID
              <a href="#!" id="hash" class="secondary-content"></a>
            </div>
            <div class="copy-icon" onclick="copy('hash')">
              <i class='material-icons copy tiny secondary-content copy-icon'>content_paste</i>
            </div>
          </li>
          <li class="collection-item tooltipped" data-html="true" data-position="top" data-tooltip="Timestamp of when this block was mined"><div>Timestamp
              <a href="#!" id="timestamp" class="secondary-content"></a>
            </div>
          </li>
          <li class="collection-item tooltipped" data-html="true" data-position="top" data-tooltip="Minima TxPoW protocol allows a transaction to randomly be a block"><div>Is A Block?
              <a href="#!" id="isblock" class="secondary-content"></a>
            </div>
          </li>
          <li class="collection-item tooltipped" data-html="true" data-position="top" data-tooltip="Random number which satisfies proof of work"><div>Nonce
            <a href="#!" id="nonce" class="secondary-content"></a>
            </div>
          </li>
          <li class="collection-item tooltipped" data-html="true" data-position="top" data-tooltip="Size of current TxPoW"><div>Size
              <a href="#!" id="size" class="secondary-content">
              </a>
            </div>
          </li>
          <li class="collection-item tooltipped" data-html="true" data-position="top" data-tooltip="Superblock level of current block"><div>Superblock Level
              <a href="#!" id="superparents-amnt" class="secondary-content">
          </a>
        </div>
        </li>
        <li class="collection-item tooltipped" data-html="true" data-position="top" data-tooltip="Transaction inputs"><div>TXN Inputs
            <a href="#!" id="inputs" class="secondary-content">
            </a>
          </div>
        </li>
        <li class="collection-item tooltipped" data-html="true" data-position="top" data-tooltip="Transaction outputs"><div>TXN Outputs
            <a href="#!" id="outputs" class="secondary-content">
            </a>
          </div>
        </li>
        <li class="collection-item tooltipped hash-wrapper" data-html="true" data-position="top" data-tooltip="Parent of current block"><div class="of-text">Parent
            <a href="#!" onclick="parentClicked()" id="parent" class="secondary-content"></a>
          </div>
          <div class="copy-icon" onclick="copy('parent')">
            <i class='material-icons copy tiny secondary-content copy-icon'>content_paste</i>
          </div>
        </li>
        <li class="collection-item tooltipped" data-html="true" data-position="top" data-tooltip="Number of transactions in this block"><div>No. of Transactions 
            <a href="#!" id="txns" class="secondary-content">
            </a>
          </div>
        </li>
        <li style="display: none;" id="msg" class="collection-item tooltipped" data-html="true" data-position="top" data-tooltip="Public message of sender"><div>Message
            <a href="#!" id="message" class="secondary-content">
            </a>
          </div>
        </li>
        <li id="_type" style="display:none;" class="collection-item tooltipped" data-html="true" data-position="top" data-tooltip="Transaction type"><div>Transaction Type
          <a href="#!" id="type" class="secondary-content">
          </a>
        </div>
      </li>
        <li style="display: none;" id="_token" class="collection-item tooltipped" data-html="true" data-position="top" data-tooltip="Name of token created in this TXN"><div>Token name
          <a href="#!" id="token" class="secondary-content">
          </a>
        </div>
      </li>
      </ul>
  </div> -->
</div>
<!--  Scripts-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsrender/1.0.7/jsrender.min.js"></script>
<script src="js/bin/materialize.js"></script>
<script src="js/Minima/minima.js"></script>
<script src="js/moment.js"></script>

  </body>
</html>
