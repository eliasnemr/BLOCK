<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
  <title>Block</title>

  <!-- CSS  -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>
</head>
<body>

  <!-- Minima.js -->
<script type="text/javascript">

  window.addEventListener("load", function(){
    window.addEventListener("MinimaEvent", function(evt){

    //Deal with each message type
		 		if(evt.detail.event == "connected"){
          // init SQL dB for blocks
          createSQL();
          // get last 128 blocks 
          get127Blocks();
		 			// set last block
          getBlock();

          Minima.sql("SELECT * from blocks", function(res){
            console.log(res);
          });
			 	}else if(evt.detail.event == "newblock"){
		 			// set last block text
          getBlock();

          // update blocks
          //updateBlocks();		 	
		 		}else if(evt.detail.event == "newbalance"){
		 			//Set the Balance..
			 		setBalance();
		    }     
    });
    // init Minima
    Minima.init();
  });
  // functions
  function getBlock() {
    document.getElementById('blocknumber').innerHTML = "<b>"+ Minima.block+"</b>";
  }
  function setBalance() {

  }

  let tip = "";let count = 0;var populateQuery = "INSERT INTO blocks (height, hash, relayed) VALUES ";
  function get127Blocks() {

    Minima.cmd("status", function(resp) {
      if(count == 0){  
        // get block header
        tip = resp.response.tip;
      }
      count++;
      // let's get the tip's parent
      Minima.cmd("txpowinfo "+tip, function(res){
        // get block header
        tip = res.response.txpow.header.superparents[0].parent;
        let height = res.response.txpow.header.block;
        let relayed = res.response.txpow.header.date;

        // callback
        if(count <= 127){
          // populate with the retrieved header
          populateBlocksSQLTable(height, tip, relayed);
          // callback
          get127Blocks();
        } else {
          return 0;
        }
      });
    }); 
  }

  // SQL to create the dB
  var initSQL = "CREATE Table IF NOT EXISTS blocks ( height VARCHAR(160) NOT NULL, hash VARCHAR(160) NOT NULL, relayed VARCHAR(160) NOT NULL);"+
                "SELECT * FROM blocks";
  // Run command to create the SQL Database
  function createSQL() {
    Minima.sql(initSQL, function(resp){
      if(!resp.status){
        alert("Something went wrong with SQL DB+\n\n"+resp.message);
        console.log(JSON.stringify(resp, null, 2));
      }
    });
  }
  // Get the recent last 128 blocks and populate local SQL IF they don't already exist
  var checkQUERY = "SELECT * FROM BLOCKS WHERE hash = '";
  function populateBlocksSQLTable(height, hash, relayed) {
    // check if hash already exists, if not populate..
    Minima.sql(checkQUERY+hash+"'", function(resp){

      console.log(JSON.stringify(resp, null, 2));
      
      // check if block already exists
      if(resp.status == true && resp.response.count == 0){
        // add to sqlÂ 
        Minima.sql(populateQuery+"('"+height+"','"+tip+"','"+relayed+"')", function(resp){
          // something went wrong, stop
          if(!resp.status){
            alert("Something went wrong with SQL DB+\n\n"+resp.message);
            console.log(JSON.stringify(resp, null, 2));
          // otherwise insert..
          } else {
            console.log("Pushed new blocks");
          }
        });
      } else {
        console.log("Block already exists!");
      }
    });
  }

  var dropTableQuery = "DROP TABLE blocks IF EXISTS;";
  // delete min height, add new block to top of table
  function updateBlocks() {
    Minima.sql(dropTableQuery, function(res){
       if(res.status){
         Minima.cmd('status', function(res){
           if(!res.status){
             alert('Something went wrong retrieving status');
           } else {
             get127Blocks();
           }
         });
       }
    });
  }


</script>

  <nav class="minima-blue-bg lighten-1" role="navigation">
    <div class="nav-wrapper container"><a id="logo-container" href="#" class="brand-logo">BLOCK</a>
      <ul class="right hide-on-med-and-down">
        <li><a href="#">About</a></li>
      </ul>
  
      <ul id="nav-mobile" class="sidenav">
        <li><a href="#">about</a></li>
      </ul>
      <a href="#" data-target="nav-mobile" class="sidenav-trigger"><i class="material-icons">menu</i></a>
    </div>
  </nav>
  <div class="section no-pad-bot" id="index-banner">
    <div class="container">
      <br><br>
      <div class="row center">
        <img style="width: 80px;" src="assets/icon.png">
      </div>
      <h1 class="header center minima-blue-txt" style="margin-top:0px;">BLOCK</h1>
        <!-- Block number -->
        <div class="row center light" id="blocknumber">
        </div>
      <div class="row center">
        <h5 class="header col s12 light">Minima's Block Explorer built for all your exploration needs.</h5> 
      </div>
      <div class="container">
        <div class="search-wrapper focused row center">
          <input id="search" placeholder="Search by block number, TxPoW id or Minima Address">
          <a href="#" id="download-button" class="btn-large waves-effect waves-light minima-orange-bg">Search</a>
        </div>
      </div>
      <br><br>
      
      <!-- Table for Blocks -->
      <table class="responsive-table highlight">
        <thead>
          <tr>
            <td>Height</td>
            <td>Hash</td>
            <td>Mined</td>
          </tr>
        </thead>

        <tbody>
          <tr>  
            <td>5003</td>
            <td>0x4A4DECE9EBE2C524A1...</td>
            <td>1 min ago</td>
          </tr> 
          <tr>  
            <td>5002</td>
            <td>0x4A4DECE9EBE2C524A1...</td>
            <td>5 mins ago</td>
          </tr> 
          <tr>  
            <td>5001</td>
            <td>0x4A4DECE9EBE2C524A1...</td>
            <td>10 mins ago</td>
          </tr>

           <!-- pagination for blocks -->
          <ul class="pagination">
          <li class="disabled"><a href="#!"><i class="material-icons">chevron_left</i></a></li>
          <li class="active"><a href="#!">1</a></li>
          <li class="waves-effect"><a href="#!">2</a></li>
          <li class="waves-effect"><a href="#!">3</a></li>
          <li class="waves-effect"><a href="#!">4</a></li>
          <li class="waves-effect"><a href="#!">5</a></li>
          <li class="waves-effect"><a href="#!"><i class="material-icons">chevron_right</i></a></li>
          </ul> 
        </tbody>
      </table>
    </div>
  </div>
  
    <div class="section hide-on-small-only show-on-large">
    <div class="row">
        <div class="col s6 offset-s3">
          <div class="card">
            <div class="card-image">
              <img src="assets/footer.jpg">
              <span class="card-title">Minima invites all.  Become a validating node.</span>
          </div>
          <div class="card-content">
              <p>Becoming a participitant in our network requires a quick installation on your native device.  Mobile, Desktop, Server or all.  Your choice.  Click below to join the network.</p>
          </div>
          <div class="card-action">
            <a href="#">Become a Minima User.</a>
          </div>
        </div>
        </div>
      </div>
    </div>

    <div class="section hide-on-large-only">
    <div class="row">
        <div class="col s12 m7">
          <div class="card">
            <div class="card-image">
              <img src="assets/footer.jpg">
              <span class="card-title">Minima invites all.  Become a validating node.</span>
          </div>
          <div class="card-content">
              <p>Becoming a participitant in our network is as easy as installing the app on any device you own and just running it.  That's all.  Click below to join the network.</p>
          </div>
          <div class="card-action">
            <a href="#">Become a Minima User.</a>
          </div>
        </div>
        </div>
      </div>
    </div>


  <div class="container">
    <div class="section">

      <!--   Icon Section   -->
      <div class="row">
        <div class="col s12 m4">
          <div class="icon-block">
            <h2 class="center light-blue-text"><i class="material-icons">flash_on</i></h2>
            <h5 class="center">Minima's Official Wallet</h5>

            <p class="light">A complete Minima Core Wallet built for Minima Node V1.0.  Learn more <a href="#">here.</a></p>
          </div>
        </div>

        <div class="col s12 m4">
          <div class="icon-block">
            <h2 class="center light-blue-text"><i class="material-icons">group</i></h2>
            <h5 class="center">MiniDAPP Community</h5>

            <p class="light">Want to build your very own MiniDAPP?  By utilizing Minima's native scripting language, you can build ontop of the MiniDAPP stack.  Learn more <a href="#">here.</a></p>
          </div>
        </div>

        <div class="col s12 m4">
          <div class="icon-block">
            <h2 class="center light-blue-text"><i class="material-icons">settings</i></h2>
            <h5 class="center">The Protocol</h5>

            <p class="light">Minima is built in the perspective of keeping the chain truely decentralised as it scales.  Every user is a node.  Every node is mobile.  Learn more about the protocol <a href="#">here.</a></p>
          </div>
        </div>
      </div>

    </div>
    <br><br>
  </div>

  <footer class="page-footer minima-grey-bg">
    <div class="container">
      <div class="row">
        <div class="col l6 s12">
          <div class="row center">
          <img style="width: 80px;" src="assets/Minima.svg">
          </div>
          <p class="grey-text text-lighten-4">Block is built for Minima with the incentive of allowing you to explore its chain.  Discover the heaviest leaf in the chain and traverse through.</p>


        </div>
        <div class="col l3 s12">
          <h5 class="white-text">Settings</h5>
          <ul>
            <li><a class="white-text" href="#!">Link 1</a></li>
            <li><a class="white-text" href="#!">Link 2</a></li>
            <li><a class="white-text" href="#!">Link 3</a></li>
            <li><a class="white-text" href="#!">Link 4</a></li>
          </ul>
        </div>
        <div class="col l3 s12">
          <h5 class="white-text">Connect</h5>
          <ul>
            <li><a class="white-text" href="#!">Link 1</a></li>
            <li><a class="white-text" href="#!">Link 2</a></li>
            <li><a class="white-text" href="#!">Link 3</a></li>
            <li><a class="white-text" href="#!">Link 4</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div class="footer-copyright minima-blue-bg">
      <div class="container">
      Made by <a class="orange-text text-lighten-3" href="#">the Minima Team</a>
      </div>
    </div>
  </footer>


  <!--  Scripts-->
  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="js/bin/materialize.js"></script>
  <script src="js/Minima/minima.js"></script>

  </body>
</html>
