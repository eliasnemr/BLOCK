<!DOCTYPE html>
<html lang="en">
<head>
  <base href="./"/>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
  <title>Block - Minima's Explorer</title>
  
  <!-- CSS  -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
  <link href="css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="css/custom.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link rel="icon" type="image/png" href="assets/blockicon.png" />
  <script src="js/jquery-3.5.1.min.js"></script>

</head>
<body>
<!-- Minima.js -->
<script type="text/javascript">

  // global table objects
  var table;var tabledata = [];

  // Minima Event Manager
  window.addEventListener("load", function(){ 

    window.addEventListener("MinimaEvent", function(evt){

    //Deal with each message type
		 		if(evt.detail.event == "connected"){
          console.log("Welcome to BLOCK!");
          // init SQL dB for blocks
          createSQL();
          // get last 128 blocks
          add127BlocksToSQL();
          // init table 
          initTable();

			 	}else if(evt.detail.event == "newblock"){

          // update SQL
          getNewBlockToSQL();
          
          // populateTable
          setTimeout(function(){
            updateTableData();
          }, 500); 
		 		}  
    });
    // init Minima
    Minima.init();
  });
  // Misc Functions to help with BLOCK 
  function getBlockNumber() {
    document.getElementById('blocknumber').innerHTML = "<b>"+ Minima.block+"</b>";
  } 
  // INIT Tabulator blocks-table.. 
  function initTable() {
    $(document).ready(function(){
      Minima.sql("SELECT DISTINCT height, hash, relayed from blocks ORDER BY height desc", function(res){

        // Create a tabulator instance, and refer it to the div canvas
          table = new Tabulator("#example-table", {
            initialSort:[

              {column:"HEIGHT", dir:"desc"}, //sort by this first

            ],
            maxHeight: 660,
            resizableColumns: false,
            layout:"fitColumns",
            headerSort: false,
            index:"HEIGHT",
            columns:[

              {title: "Height", field: "HEIGHT", width: 90, sorter: "number", cssClass: "height-column"},

              {title: "Hash", field: "HASH", formatter:function(cell, formatterParams){
                var hash = cell.getData();
                hash = hash.HASH.substring(0, 1) + "..." + hash.HASH.substring(6, 80);
                return hash;
              }},
              {title: "Relayed", field:"RELAYED", width:180, formatter:function(cell, formatterParams){
                  var time = cell.getData();
                  time = new Date(parseInt(time.RELAYED, 10)).toISOString();
                  time = moment(time).fromNow();
                  return time;
              }},

            ],
            rowClick:function(e, row){

              var clickedrow = row._row.data;
          
              //row - row component
              console.log("USEREVENT: Clicked Row."+ clickedrow.HEIGHT);
            
              var relativeHash = clickedrow.HASH;
              // add to localStorage to pass to details.html..
              localStorage.setItem("relativeHash", clickedrow.HASH);

              window.location.href = './details.html?'+relativeHash;

              return false;

            },
          });
        
          var temp = [];

        // Loop through the json rows arr and add..
          $.each(res.response.rows, function(i, el){
            
            temp.push(el);        

          });
          
          /** SET Data to the Tabulator REF */
          table.setData(temp)
          .then(function(){

              //run code after table has been successfully updated
              //console.log("TABULATOR: Added new data to the Table");

          })
          .catch(function(error){

              //handle error loading data
              console.log(error);

          });
      });
    });
  }
  
/** Update Tabulator Table with new blocks */
  function updateTableData() {
    
    $(document).ready(function(){

        Minima.sql("SELECT DISTINCT height, hash, relayed from blocks ORDER BY height desc", function(res){

          // Loop through the json rows arr and add..
          var temp = []; 

          $.each(res.response.rows, function(i, el){
              
              temp.push(el);        
       
          });
          /** SET Data to the Tabulator REF as a promise */
          table.replaceData(temp)
          .then(function(){

              //run code after table has been successfully updated
              // console.log("TABULATOR: Added new data to the Table");

          })
          .catch(function(error){
              //handle error loading data
              console.log(error);
          });
        });
    });
  }
  // SQL to create the dB
  var INITSQL = "CREATE Table IF NOT EXISTS blocks ( height VARCHAR(160) NOT NULL, hash VARCHAR(160) NOT NULL, relayed VARCHAR(160) NOT NULL);"+
                "SELECT DISTINCT height, hash, relayed FROM blocks";
/** Create SQL Table */
  function createSQL(){
    Minima.sql(INITSQL, function(resp){
      //console.log(resp);
      if(!resp.status){

        alert("Something went wrong with SQL DB+\n\n"+resp.message);

      }
    });
  }
  var hash = "";var height="";var relayed="";var count = 0;var parent=""
  var POPULATEQUERY = "INSERT INTO blocks (height, hash, relayed) VALUES ";
// Recursive function to fetch prev 127 blocks from Minima to SQL
  function add127BlocksToSQL() {

    if(count == 0){

    hash = Minima.status['tip'];

    height = Minima.status['lastblock'];

      // do this to get timesecs
      Minima.cmd("txpowinfo "+hash, function(res){

        relayed = (res.response.txpow.header.timesecs)*1000;

        // relayed = moment(relayed);
        // relayed = relayed._d;
        // relayed = moment(relayed._d, 'YYYY-MM-DDTHH:mm:ssZ').format();
        // relayed = moment(relayed).fromNow();

        addRecord(height, hash, relayed); // h2 sql

      });

    }
    // let's get the tip's parent to traverse through..
    Minima.cmd("txpowinfo "+hash, function(res){

      // get block's parent block
      parent = res.response.txpow.header.superparents[0].parent;

      Minima.cmd("txpowinfo "+parent, function(res) {

        hash = res.response.txpow.txpowid;

        height = res.response.txpow.header.block;

        relayed = (res.response.txpow.header.timesecs)*1000;

        addRecord(height, hash, relayed); // h2 sql

        // callback
        if(count < 128){

          count++;

          add127BlocksToSQL();
        } else {
          return 0;
        }
      });
    });
  }
/** ADD TO SQL */ 
  var CHECKQUERY = "SELECT DISTINCT height, hash, relayed FROM blocks WHERE hash = '";
  function addRecord(height, hash, relayed) {

    // check if hash already exists, if not populate..
    Minima.sql(CHECKQUERY+hash+"'", function(resp){

      // check if block already exists
      if(resp.response.status == true && resp.response.count == 0){
        // add 2 sql
        Minima.sql(POPULATEQUERY+"('"+height+"','"+hash+"','"+relayed+"')", function(resp){

          // something went wrong, stop
          if(!resp.status){

            alert("H2 SQL: Something went wrong adding the new record+\n\n"+resp.message);

          // otherwise insert..
          } else {

            //console.log("H2 SQL: Pushed a new block to SQL Database.");

          }
        });
      } else {

        //console.log("H2 SQL: Block already exists in SQL Database!");

      }
    });
  }
/** Get the tip added to SQL */
  function getNewBlockToSQL() {  

    // Get tip of chain 
    tip = Minima.status['tip'];

    // Check if this block exists 
    Minima.sql(CHECKQUERY+tip+"'", function(resp){
    if(resp.response.status == true && resp.response.count == 0){

      height = Minima.status['lastblock'];

      // only way to get time in secs for now...
      Minima.cmd("txpowinfo "+tip, function(res){

      relayed = (res.response.txpow.header.timesecs)*1000;

      // delete last row
      deleteMIN();

      // Add tip to SQL list  
      addRecord(height, tip, relayed);

      });
      

    }
      
    });
  }
/** Delete last row w/ MIN(height) in sql */
var DELETELASTQUERY = "DELETE FROM blocks WHERE (height = (SELECT MIN(height) FROM blocks))";
  function deleteMIN() {
    Minima.sql(DELETELASTQUERY, function(res){  
      if(res.status == true){

        return;
      }
    });
  }

  // JQUERY Helpful Functions
  $(document).ready(function() {
    
    if(localStorage.getItem('mode') == 'dark'){
      $('body').addClass("dark");
      $('.dark-toggle').find('i').text('brightness_high');
      $('.body-icon').attr("src", "assets/blocklogowhitetext.svg");
    } else if (localStorage.getItem('mode') == 'light') {
      $('body').removeClass("dark");
      $('.dark-toggle').find('i').text('brightness_4');
      $('.body-icon').attr("src", "assets/blocklogo.svg");
    }

    // Materialize tooltip
    $('.tooltipped').tooltip({delay: 50});
    
    // elias github
    $("#elias").on("click", function(){

      window.open('https://github.com/eliasnemr', '_blank'); 

    });

  $("#searchBtn").on("click", function(){
        
    var addr = $("#search-input").val().toLowerCase();
        // quit exit if nothing
        if(addr.length == ""){

          $('#example-table').fadeIn(100);

          $('#results-table').fadeOut(100);

  }

  Minima.cmd("txpowsearch input:"+addr, function(res){
    if(res.status == true){
      if(res.response.txpowlist.length > 0){

        // something found.. load it
        loadData(res);

      } else {
        Minima.cmd("txpowsearch output:"+addr, function(res){
          if(res.status == true){
            if(res.response.txpowlist.length > 0){

              // something found.. load it
              loadData(res);

            } else {
              Minima.cmd("txpowsearch tokenid:"+addr, function(res){

                if(res.status == true){
                  if(res.response.txpowlist.length > 0){

                  // something found.. load it
                  loadData(res);

                  } else {

                    // nothing found.. display to user 
                    var markup = "<p class='center row nothing'>Nothing found with that address.</p>";

                    if (!$('.nothing').length){

                      $("#example-table").before(markup);

                      $(".nothing").show(2000); 

                    }
                    
                    setTimeout(function(){

                      $(".nothing").remove();

                    }, 5000);
                  }
                }
              });
            }
          }
        });
      }
    } 
  });
});

// Detect enter key for input 
$('#search-input').keypress(function(event){

  var keycode = (event.keyCode ? event.keyCode : event.which);

  if(keycode == '13'){

      var addr = $("#search-input").val().toLowerCase();
      // quit exit if nothing
      if(addr.length == ""){

       $('#example-table').fadeIn(100);

       $('#results-table').fadeOut(100);

      }
      Minima.cmd("txpowsearch input:"+addr, function(res){
        if(res.status == true){
          if(res.response.txpowlist.length > 0){

              // something found.. load it
              loadData(res);

          } else {
            Minima.cmd("txpowsearch output:"+addr, function(res){
              if(res.status == true){
                if(res.response.txpowlist.length > 0){

                  // something found.. load it
                    loadData(res);

                } else {
                  Minima.cmd("txpowsearch tokenid:"+addr, function(res){
                    if(res.status == true){
                      if(res.response.txpowlist.length > 0){

                      // something found.. load it
                        loadData(res);

                      } else {
                      
                      // nothing found.. display to user 
                      var markup = "<p class='center row nothing'>Nothing found with that address.</p>";

                      if (!$('.nothing').length){

                        $("#example-table").before(markup);

                        $(".nothing").show(2000); 

                      }
                      setTimeout(function(){
                        $(".nothing").remove();
                      }, 5000);
                    }
                    }
                  });
                }
              }
            });
          }
        } 
      });
  }
  //Stop the event from propogation to other handlers
  //If this line will be removed, then keypress event handler attached 
  //at document level will also be triggered
  event.stopPropagation();
});

function loadData(res){

      var results = 0;
      
      results = res.response.txpowlist.length;

      if(results == 1){
        var found = "<p class='center row something'>Found "+ results +" result!</p>"
      } else if (results > 1){

        var found = "<p class='center row something'>Found "+ results +" results!</p>";

      }

      if (!$('.something').length){

        $("#results-table").before(found);

      }
      setTimeout(function(){
        $(".something").remove();
      }, 3000);

      $('#example-table').fadeOut(100);

       // Create a tabulator instance, and refer it to the div canvas
       var resultstable = new Tabulator("#results-table", {
            initialSort:[
            { column:"HEIGHT", dir:"desc" }, //sort by this first
            ],
            index:"HEIGHT",
            columns:[

              {title: "Height", field: "HEIGHT", width: 100, cssClass:"height-column"},

              {title: "Hash", field: "HASH"},

              {title: "Timestamp", field:"RELAYED", width:150}
            ],
            headerSort: false,
            pagination:"local",
            paginationSize:15,
            layout:"fitColumns",
            rowClick:function(e, row){

              var clickedrow = row._row.data;
          
              //row - row component
              console.log("USEREVENT: Clicked Row."+ clickedrow.HEIGHT);
            
              var relativeHash = clickedrow.HASH;
              // add to localStorage to pass to details.html..
              localStorage.setItem("relativeHash", clickedrow.HASH);

              window.location.href = './details.html?'+relativeHash;

              return false;

            },
          });
        
     

      var lastHeight = "";    
      $.each(res.response.txpowlist.reverse(), function(i, el){
        
        var height = el.inblock;

        var hash = el.txpow.txpowid;

        var relayed = el.txpow.header.timesecs;

        var dt = relayed;

        var timeFrom2 = new Date(dt*1000).toISOString();

        var timeFrom = moment(timeFrom2).fromNow();
        
        var result = {HEIGHT: height, HASH: hash, RELAYED: timeFrom}

      if(lastHeight !== height){

        resultstable.addData(result);

      }
      lastHeight = height;
    });
    
    }


    });
</script>

  <div class="navbar-fixed">
  <nav class="menu minima-black-bg" data-target="menu" role="navigation">
    <div class="nav-wrapper container"><a id="logo-container" href="#" class="brand-logo">
    <img style="width: 110px; padding-top: 11px;" class="hide-on-small-only" src="assets/blocklogowhitetext.svg">
    <img style="width: 80px; padding-top: 10px; padding-bottom: 0px;" class="hide-on-large-only hide-on-med-only" src="assets/blocklogowhitetext.svg">
    </a>


    <ul id="slide-out" class="right minima-blue-txt">
      <li class="hide-on-small-only">
        <!-- <a href="charts.html">Charts</a> -->
        <a href="#">Charts</a>

      </li>
      <li><a 
      class="dark-toggle" 
      href="#" 
      title="Dark/light">
       <i class="material-icons left">brightness_4</i></a>
      </li>
      </ul>
    <ul>
      

    </ul>
    </div>
             
    
  </nav>
  </div>

  <div class="navbar-fixed">
  <nav class="menu minima-grey-bg explorer-wrapper" data-target="menu">
    <div class="nav-wrapper container">
      <div class="col s12">
        <a href="index.html" class="breadcrumb explorer">Explorer</a>
      </div>
    </div>
  </nav>
  </div>
  <!-- Body INFO -->
  <div class="section" id="index-banner">
    <div class="container" >
      <br><br>
      <div class="row center">
        <img class="body-icon responsive-img" src="assets/blocklogo.svg">
      </div>
        

      <div class="container center">
        <div class="search-wrapper my-search-wrap">
          <input id="search-input" class="tooltipped center-align" placeholder="Search by Hex or Mini Address" type="text" data-html="true" data-position="top" data-tooltip="Limits to the last 300 blocks (Address for Input, Output or token ID)">
          <i id="searchBtn" class="material-icons search">search</i>
        </div>
      </div>

      </div>
    </div>

    <div class="section table-section" id="index-banner">
      <div class="container center">
          
          <!-- TABULATOR - BLOCKS table -->
          <div id="example-table"></div>
          <div id="results-table" style="display:none;"></div>  
        
        <a class="btn waves-effect waves-light load-btn"> Load More </a>
      </div>


    </div>
  
    


  <footer class="page-footer minima-black-bg">
    <div class="container">
      <div class="row">
        <div class="col l6 s12">
          <div class="left-align">
          <img width="180" src="assets/minilogoblacklandscape.svg">
          </div>
          <p class="grey-text">Block, the Minima Block Explorer.  Discover the heaviest leaf in the chain and traverse through.</p>
        </div>
        <div class="col l3 s12">

        </div>
        <div class="col l3 s12">
          <h5 class="white-text">Connect</h5>
          <ul>
            <li><a class="grey-text" href="https://t.me/Minima_Global" target="_blank">Telegram</a></li>
            <li><a class="grey-text" href="https://twitter.com/Minima_Global" target="_blank">Twitter</a></li>
            <li><a class="grey-text" href="https://medium.com/minima-global" target="_blank">Medium</a></li>
            <li><a class="grey-text" href="https://github.com/spartacusrex99/Minima" target="_blank">Github</a></li>
            <li><a class="grey-text" href="https://minima.global/" target="_blank">Official Website</a></li>
          </ul>
        </div>
      </div>
    </div>
  </footer>


  <!--  Scripts-->
  <link href="https://unpkg.com/tabulator-tables@4.7.1/dist/css/tabulator.min.css" rel="stylesheet">
  <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.7.1/dist/js/tabulator.min.js"></script>
  <script src="js/bin/materialize.js"></script>
  <script src="js/Minima/minima.js"></script>
  <script src="js/moment.js"></script>

  <script>
  $(document).ready(function() {

    // load more btn
    $('.load-btn').on('click', function(){

      var size = $('#example-table').css('max-height').replace(/[^-\d\.]/g, '');

      console.log("Load Btn Clicked and the max-height of the table is :"+size );

      size = parseInt(size, 10) + 264;

      document.getElementById("example-table").style.maxHeight = size+"px";

      table.redraw(true);
    
      
    });

    // SWAP ICON ON CLICK
    // Source: https://stackoverflow.com/a/34254979/751570
    $('.dark-toggle').on('click',function(){
      if ($(this).find('i').text() == 'brightness_4'){
          $(this).find('i').text('brightness_high');
          $('.body-icon').attr("src", "assets/blocklogowhitetext.svg");
          $('body').addClass("dark");
          localStorage.setItem('mode', 'dark');
      } else {
          $(this).find('i').text('brightness_4');
          $('.body-icon').attr("src", "assets/blocklogo.svg");
          $('body').removeClass("dark");
          localStorage.setItem('mode', 'light');
      }
    });

  });
  </script>
  </body>
</html>
