<!DOCTYPE html>
<html lang="en">
<head>
  <base href="./"/>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
  <title>Block - Minima's Explorer</title>
  
  <!-- CSS  -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
  <link href="css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link rel="icon" type="image/png" href="assets/blockicon.png" />
  <script src="js/jquery-3.5.1.min.js"></script>

</head>
<body>
<!-- Minima.js -->
<script type="text/javascript">
  // global table objects
  var table;var tabledata = [];
  // Minima Event Manager
  window.addEventListener("load", function(){ 
    window.addEventListener("MinimaEvent", function(evt){
    //Deal with each message type
		 		if(evt.detail.event == "connected"){
          console.log("Welcome to BLOCK!");
          // init SQL dB for blocks
          createSQL();
          // get last 128 blocks
          add127BlocksToSQL();
          // init table 
          initTable();

		 			// set block # sub heading
          getBlockNumber();

			 	}else if(evt.detail.event == "newblock"){
		 			// set last block text
          getBlockNumber();

          // update SQL
          getNewBlockToSQL();
          
          // populateTable
          setTimeout(function(){
            updateTableData();
          }, 500); 
		 		}  
    });
    // init Minima
    Minima.init();
  });
  // Misc Functions to help with BLOCK 
  function getBlockNumber() {
    document.getElementById('blocknumber').innerHTML = "<b>"+ Minima.block+"</b>";
  } 
  // INIT Tabulator blocks-table.. 
  function initTable() {
    $(document).ready(function(){
      Minima.sql("SELECT DISTINCT height, hash, relayed from blocks ORDER BY height desc", function(res){
        console.log(res);
        // Create a tabulator instance, and refer it to the div canvas
          table = new Tabulator("#example-table", {
            initialSort:[
            {column:"HEIGHT", dir:"desc"}, //sort by this first
            ],
            index:"HEIGHT",
            height: 500,
            columns:[
              {title: "Height", field: "HEIGHT", width: 100, sorter: "number", headerSort:true},
              {title: "Hash", field: "HASH", headerSort:false},
              {title: "Relayed", field:"RELAYED", width:150, headerSort:false}
            ],
            pagination:"local",
            paginationSize:15,
            layout:"fitColumns",
            rowClick:function(e, row){
              var clickedrow = row._row.data;
          
              //row - row component
              console.log("USEREVENT: Clicked Row."+ clickedrow.HEIGHT);
            
              var relativeHash = clickedrow.HASH;
              // add to localStorage to pass to details.html..
              localStorage.setItem("relativeHash", clickedrow.HASH);

              window.location.href = './details.html?'+relativeHash;
              return false;

            },
          });
        
          var temp = [];var count=0;
        // Loop through the json rows arr and add..
          $.each(res.response.rows, function(i, el){

            var dt = el.RELAYED;
            var timeFrom2 = new Date((dt*1000)).toISOString();
            var timeFrom = moment(timeFrom2).fromNow();
            el.RELAYED = timeFrom;
            
            if(count <=127){
              temp.push(el);
              count++;
            } else {
              return;
            }

          });

          /** SET Data to the Tabulator REF */
          table.setData(temp)
          .then(function(){
              //run code after table has been successfully updated
              console.log("TABULATOR: Added new data to the Table");
          })
          .catch(function(error){
              //handle error loading data
              console.log(error);
          });
      });
    });
  }
  /** Get min of */ 
  function getMin(arr, prop) {
    var min;
    for (var i=0 ; i<arr.length ; i++) {
        if (min == null || parseInt(arr[i][prop]) > parseInt(min[prop]))
            min = arr[i];
    }
    return min;
  }
/** Update Tabulator Table with new blocks */
  function updateTableData() {
    $(document).ready(function(){
        Minima.sql("SELECT DISTINCT height, hash, relayed from blocks ORDER BY height desc", function(res){
          // Loop through the json rows arr and add..
          var temp = [];var count=0;
          $.each(res.response.rows, function(i, el){
            // time-secs -> time-ago
            var dt = el.RELAYED;
            var timeFrom2 = new Date((dt*1000)).toISOString();
            var timeFrom = moment(timeFrom2).fromNow();
            el.RELAYED = timeFrom;
            // push to temp arr
            if(count <=127){
              temp.push(el);
              count++;
            } else {
              return;
            }
          });
          /** SET Data to the Tabulator REF as a promise */
          table.replaceData(temp)
          .then(function(){
              //run code after table has been successfully updated
              console.log("TABULATOR: Added new data to the Table");
          })
          .catch(function(error){
              //handle error loading data
              console.log(error);
          });
        });
    });
  }
  // SQL to create the dB
  var INITSQL = "CREATE Table IF NOT EXISTS blocks ( height VARCHAR(160) NOT NULL, hash VARCHAR(160) NOT NULL, relayed VARCHAR(160) NOT NULL);"+
                "SELECT DISTINCT height, hash, relayed FROM blocks";
  // Run command to create the SQL Database
  function createSQL(){
    Minima.sql(INITSQL, function(resp){
      console.log(resp);
      if(!resp.status){
        alert("Something went wrong with SQL DB+\n\n"+resp.message);
        console.log(JSON.stringify(resp, null, 2));
      }
    });
  }
  var hash = "";var height="";var relayed="";var count = 0;var parent = "";
  var POPULATEQUERY = "INSERT INTO blocks (height, hash, relayed) VALUES ";
  // Recursive function to traverse through BST to find parents 
  function add127BlocksToSQL() {
    if(count == 0){
    hash = Minima.status['tip'];
    height = Minima.status['lastblock'];
    // do this to get time in seconds..
    Minima.cmd("txpowinfo "+hash, function(res){
      relayed = res.response.txpow.header.timesecs;
    });
      populateBlocksSQLTable(height, hash, relayed);
    }
    // let's get the tip's parent to traverse through binary tree..
    Minima.cmd("txpowinfo "+hash, function(res){
      // get block's parent block
      parent = res.response.txpow.header.superparents[0].parent;
      Minima.cmd("txpowinfo "+parent, function(res) {
        hash = res.response.txpow.txpowid;
        height = res.response.txpow.header.block;
        relayed = res.response.txpow.header.timesecs;

        // INSERT INTO to SQL table
        populateBlocksSQLTable(height, hash, relayed);

        // callback
        if(count < 128){
          count++;
          add127BlocksToSQL();
        } else {
          return 0;
        }
      });
    });
  }
  // Get the recent last 128 blocks and populate local SQL IF they don't already exist
  var CHECKQUERY = "SELECT DISTINCT height, hash, relayed FROM BLOCKS WHERE hash = '";
  function populateBlocksSQLTable(height, hash, relayed) {
    // check if hash already exists, if not populate..
    Minima.sql(CHECKQUERY+hash+"'", function(resp){
      // check if block already exists
      if(resp.response.status == true && resp.response.count == 0){
        // add to sqlÂ 
        Minima.sql(POPULATEQUERY+"("+height+",'"+hash+"','"+relayed+"')", function(resp){
          // something went wrong, stop
          if(!resp.status){
            alert("H2 SQL: Something went wrong adding the new record+\n\n"+resp.message);
          // otherwise insert..
          } else {
            console.log("H2 SQL: Pushed a new block to SQL Database.");
          }
        });
      } else {
        console.log("H2 SQL: Block already exists in SQL Database!");
      }
    });
  }
  var DELETELASTQUERY = "DELETE FROM blocks WHERE (height = (SELECT MIN(height) FROM blocks))";
  function getNewBlockToSQL() {  
    // Get tip of chain 
    tip = Minima.status['tip'];
    // Check if this block exists 
    Minima.sql(CHECKQUERY+tip+"'", function(resp){
    if(resp.response.status == true && resp.response.count == 0){

      height = Minima.status['lastblock'];
      // only way to get time in secs for now...
      Minima.cmd("txpowinfo "+tip, function(res){
        relayed = res.response.txpow.header.timesecs;
      });
      // delete last row
      deleteMIN();
      // Add tip to SQL list  
      populateBlocksSQLTable(height, tip, relayed);
    }
      
    });
  }

  function deleteMIN() {
    // Delete bottom of list 
    Minima.sql(DELETELASTQUERY, function(res){  
      if(res.status == true){
        console.log("H2 SQL : Deleted min record");
        return;
      }
    });
  }

  // JQUERY Helpful Functions
  $(document).ready(function() {
    // Materialize tooltip
    $('.tooltipped').tooltip({delay: 50});
    
    // elias github
    $("#elias").on("click", function(){
      window.open('https://github.com/eliasnemr', '_blank'); 
    });

  $("#searchBtn").on("click", function(){
        
    var addr = $("#search-input").val().toLowerCase();
        // quit exit if nothing
        if(addr.length == ""){
          location.reload();
      }
  Minima.cmd("txpowsearch input:"+addr, function(res){
    if(res.status == true){
      if(res.response.txpowlist.length > 0){
        // something found.. load it
        loadData(res);
      } else {
        Minima.cmd("txpowsearch output:"+addr, function(res){
          if(res.status == true){
            if(res.response.txpowlist.length > 0){
              // something found.. load it
              loadData(res);
            } else {
              Minima.cmd("txpowsearch tokenid:"+addr, function(res){
                if(res.status == true){
                  if(res.response.txpowlist.length > 0){
                  // something found.. load it
                  loadData(res);
                  } else {
                    // nothing found.. display to user 
                    var markup = "<p class='center row nothing'>Nothing found with that address.</p>"
                    $("#blocks-table").before(markup);
                    $(".nothing").show(2000);
                    setTimeout(function(){
                      $(".nothing").remove();
                    }, 5000);
                  }
                }
              });
            }
          }
        });
      }
    } 
  });
});

// Detect enter key for input 
$('#search-input').keypress(function(event){
  var keycode = (event.keyCode ? event.keyCode : event.which);
  if(keycode == '13'){
      var addr = $("#search-input").val().toLowerCase();
      // quit exit if nothing
      if(addr.length == ""){
        location.reload();
      }
      Minima.cmd("txpowsearch input:"+addr, function(res){
        if(res.status == true){
          if(res.response.txpowlist.length > 0){
              // something found.. load it
              loadData(res);
          } else {
            Minima.cmd("txpowsearch output:"+addr, function(res){
              if(res.status == true){
                if(res.response.txpowlist.length > 0){
                  // something found.. load it
                    loadData(res);
                } else {
                  Minima.cmd("txpowsearch tokenid:"+addr, function(res){
                    if(res.status == true){
                      if(res.response.txpowlist.length > 0){
                      // something found.. load it
                        loadData(res);
                      } else {
                      // nothing found.. display to user 
                      var markup = "<p class='center row nothing'>Nothing found with that address.</p>"
                      $("#blocks-table").before(markup);
                      $(".nothing").show(2000);
                      setTimeout(function(){
                        $(".nothing").remove();
                      }, 5000);
                    }
                    }
                  });
                }
              }
            });
          }
        } 
      });
  }
  //Stop the event from propogation to other handlers
  //If this line will be removed, then keypress event handler attached 
  //at document level will also be triggered
  event.stopPropagation();
});

function loadData(res){
   $('#blocks-table tbody').empty();
      var lastHeight = "";    
      $.each(res.response.txpowlist.reverse(), function(i, el){
        
        var height = el.inblock;
        var hash = el.txpow.txpowid;
        var relayed = el.txpow.header.timesecs;
        var dt = relayed;
        var timeFrom2 = new Date(dt*1000).toISOString();
        var timeFrom = moment(timeFrom2).fromNow();
        
        
        var markup = "<tr>"+
                      "<td>"+height+"</td>"+
                      "<td>"+hash.substring(0, 80)+"...</td>"+
                      "<td>"+timeFrom+"</td>"+
                      "<td style='display:none !important;'>"+hash+"</td>"+
                      "</p>";
      if(lastHeight !== height){
        $('#blocks-table tbody').append(markup);
      }
      lastHeight = height;
    })
}



});
</script>

  <div class="navbar-fixed">
  <nav class="menu minima-black-bg" data-target="menu" role="navigation">
    <div class="nav-wrapper container"><a id="logo-container" href="#" class="brand-logo">
    <img style="width: 110px; padding-top: 11px;" class="hide-on-small-only" src="assets/blocklogowhitetext.svg">
    <img style="width: 80px; padding-top: 10px; padding-bottom: 0px;" class="hide-on-large-only" src="assets/blocklogowhitetext.svg">
    </a>


    <ul class="right minima-blue-txt">
      <li>
        <a href="charts.html">Charts</a>
      </li>
    </ul>
    </div>
             
    
  </nav>
  </div>

  <div class="navbar-fixed">
  <nav class="menu minima-grey-bg" data-target="menu">
    <div class="nav-wrapper container">
      <div class="col s12">
        <a href="index.html" class="breadcrumb explorer">Explorer</a>
      </div>
    </div>
  </nav>
  </div>
  <!-- Body INFO -->
  <div class="section no-pad-bot" id="index-banner">
    <div class="container">
      <br><br>
      <div class="row center">
        <img style="width: 300px;" src="assets/blocklogo.svg">
      </div>
        <!-- Block number -->
        <div class="row center bold" style="font-weight: 400;" id="blocknumber">
        </div>
      <div class="row center">
        <h5 class="header col s12 light subtitle">Minima's Block Explorer built for all your exploration needs.</h5> 
      </div>

     


      <div class="container center">
        <div class="search-wrapper my-search-wrap">
          <input id="search-input" class="tooltipped center-align" placeholder="Search by Hex or Mini Address" type="text" data-html="true" data-position="top" data-tooltip="Limits to the last 300 blocks (Address for Input, Output or token ID)">
          <i id="searchBtn" class="material-icons search">search</i>
        </div>
      </div>
      
      <!-- TABULATOR - BLOCKS table -->
        <div id="example-table"></div>  
      </div>
    </div>
  
    <!-- Become a Minima User advertisement -->
    <div class="section hide-on-small-only show-on-large">
    <div class="row">
        <div class="col s6 offset-s3">
          <div class="card">
            <div class="card-image">
              <img src="assets/footer.jpg">
              <span class="card-title">Minima invites all.  Become a validating node.</span>
          </div>
          <div class="card-content">
              <p>Becoming a participitant in our network requires a quick installation on your native device.  Mobile, Desktop, Server or all.  Your choice.  Click below to join the network.</p>
          </div>
          <div class="card-action">
            <a href="https://github.com/spartacusrex99/Minima" target="_blank">Become a Minima User.</a>
          </div>
        </div>
        </div>
      </div>
    </div>

    <div class="section hide-on-large-only hide-on-med-only">
    <div class="row">
        <div class="col s12 m7">
          <div class="card">
            <div class="card-image">
              <img src="assets/footer.jpg">
              <span class="card-title">Minima invites all.  Become a validating node.</span>
          </div>
          <div class="card-content">
              <p>Becoming a participitant in our network is as easy as installing the app on any device you own and just running it.  That's all.  Click below to join the network.</p>
          </div>
          <div class="card-action">
            <a href="https://github.com/spartacusrex99/Minima" target="_blank">Become a Minima User.</a>
          </div>
        </div>
        </div>
      </div>
    </div>


  <div class="container">
    <div class="section">

      <!--   Icon Section   -->
      <div class="row">
        <div class="col s12 m4">
          <div class="icon-block">
            <h2 class="center light-blue-text"><i class="material-icons">flash_on</i></h2>
            <h5 class="center">Minima's Official Wallet</h5>

            <p class="light">A complete Minima Core Wallet built for Minima Node V1.0.  Learn more <a href="http://mifi.minima.global/minidapps.html" target="_blank">here.</a></p>
          </div>
        </div>

        <div class="col s12 m4">
          <div class="icon-block">
            <h2 class="center light-blue-text"><i class="material-icons">group</i></h2>
            <h5 class="center">MiniDAPP Community</h5>

            <p class="light">Want to build your very own MiniDAPP?  By utilizing Minima's native scripting language, you can build ontop of the MiniDAPP stack.  Learn more <a href="http://mifi.minima.global/developers.html" target="_blank">here.</a></p>
          </div>
        </div>

        <div class="col s12 m4">
          <div class="icon-block">
            <h2 class="center light-blue-text"><i class="material-icons">settings</i></h2>
            <h5 class="center">The Protocol</h5>

            <p class="light">Minima is built in the perspective of keeping the chain truely decentralised as it scales.  Every user is a node.  Every node is mobile.  Learn more about the protocol <a href="https://minima.global/minima-whitepaper-v6.pdf" target="_blank">here.</a></p>
          </div>
        </div>
      </div>

    </div>
    <br><br>
  </div>

  <footer class="page-footer minima-black-bg">
    <div class="container">
      <div class="row">
        <div class="col l6 s12">
          <div class="left-align">
          <img width="180" src="assets/minilogoblacklandscape.svg">
          </div>
          <p class="grey-text">Block is built for Minima with the incentive of allowing you to explore its chain.  Discover the heaviest leaf in the chain and traverse through.</p>
        </div>
        <div class="col l3 s12">

        </div>
        <div class="col l3 s12">
          <h5 class="white-text">Connect</h5>
          <ul>
            <li><a class="grey-text" href="https://t.me/Minima_Global" target="_blank">Telegram</a></li>
            <li><a class="grey-text" href="https://twitter.com/Minima_Global" target="_blank">Twitter</a></li>
            <li><a class="grey-text" href="https://medium.com/minima-global" target="_blank">Medium</a></li>
            <li><a class="grey-text" href="https://github.com/spartacusrex99/Minima" target="_blank">Github</a></li>
            <li><a class="grey-text" href="https://minima.global/" target="_blank">Official Website</a></li>

          </ul>
        </div>
      </div>
    </div>
    <div class="footer-copyright minima-grey-bg">
      <div class="container">
      <a id="elias" href="https://github.com/eliasnemr" target="_blank"><i style="color: white;"class="material-icons">code</i></a>
      </div>
    </div>
  </footer>


  <!--  Scripts-->
  <link href="https://unpkg.com/tabulator-tables@4.7.1/dist/css/tabulator.min.css" rel="stylesheet">
  <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.7.1/dist/js/tabulator.min.js"></script>
  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="js/bin/materialize.js"></script>
  <script src="js/Minima/minima.js"></script>
  <script src="js/moment.js"></script>
  <script src="https://d3js.org/d3-array.v2.min.js"></script>
  <script src="js/materialize-pagination.js"></script>
  </body>
</html>
